<html>
    <body ng-app="myApp" ng-controller="myCtrl" ng-model="myaccount">
    <table id='result' style="text-align: center;" class="h2">
        <tr>
            <td>TESTNAME </td>
            <td>STATUS</td>
            <td>Value</td>
        </tr>
    </table>
    <button class="btn" ng-click="createAccount()">createAccount</button>
    <div> Account Id {{ myaccount }} </div>
    </body>
<script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.js"></script>
<script src="//ajax.googleapis.com/ajax/libs/angularjs/1.4.3/angular.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/json2/20121008/json2.js"></script>
<script src="//developer.oanda.com/oandajs/oanda.js"></script>
<script type="text/javascript">

var OANDA = OANDA || {};

OANDA.baseURL = OANDA.baseURL || "http://api-sandbox.oanda.com";


OANDA.auth = OANDA.auth || {};
OANDA.auth.enabled = OANDA.auth.enabled || false;
OANDA.auth.token = OANDA.auth.token || "";

	var app = angular.module('myApp', []);
	app.controller('myCtrl', function($scope) {
			$scope.createAccount =	function() {
			OANDA.account.register('USD', function(accountoanda) {$scope.myaccount = accountoanda.accountId;});
			}
	});

var setAuthHeader = function(xhr) {
    xhr.setRequestHeader("Authorization", "Bearer " + OANDA.auth.token);
};

var sendAjaxRequest = function(endpoint, method, parameters, requiresAuth, onComplete) {
    var contentType = "";
    if(method === 'POST' || method === 'PUT' || method === 'PATCH') {
        contentType = "application/x-www-form-urlencoded";
    }
    var beforeSend = function() {};
    if(OANDA.auth.enabled && requiresAuth) {
        beforeSend = setAuthHeader;
    }
    var req = $.ajax({
        url: OANDA.baseURL + endpoint,
        type: method,
        dataType: 'json',
        data : parameters,
        contentType: contentType,
        beforeSend: beforeSend,
    });
    req.always(onComplete);
};

/* Send a raw api request on an endpoint.
 */
OANDA.api = function(endpoint, method, parameters, callback) {

    sendAjaxRequest(endpoint, method, parameters, true, function(jqXHR, textResponse) {
        var response = {};
        if(textResponse != 'success') {
            response.error = { 'HTTPCode' : jqXHR.status };
            try {
                var errorJSON = JSON.parse(jqXHR.responseText);
                $.extend(response.error, errorJSON);
            } catch(e) {
            }
        } else {
            response = jqXHR;
        }
        if(callback) {
            callback(response);
        }
    });
};

OANDA.transaction = OANDA.transaction || {};

/*
 * Lists all transactions for a specified account.
 * Accepts optional parameters:
 * maxId      => Number
 * mindId     => Number
 * count      => Number
 * Instrument => String
 *
 */
OANDA.transaction.list = function(accountId, optParameters, callback) {
    //Disallow passing ids parameter (use listSpecific instead).
    if(optParameters.ids) { delete optParameters.ids; }
    OANDA.api("/v1/accounts/" + accountId + "/transactions", 'GET', optParameters, callback);
};

/* List specific transactions by transaction id.
 * Accepts no optional parameters
 */
OANDA.transaction.listSpecific = function(accountId, transId, callback) {
    OANDA.api("/v1/accounts/" + accountId + "/transactions/" + transId, 'GET', {}, callback);
};

OANDA.trade = OANDA.trade || {};

/* List all trade in account.
 * Accepts optional parameters:
 * maxId      => Number
 * count      => Number
 * instrument => Number
 */
OANDA.trade.list = function(accountId, optParameters, callback) {
    if(optParameters.ids) { delete optParameters.ids; }
    OANDA.api("/v1/accounts/" + accountId + "/trades", 'GET', optParameters, callback);
};

/* List specific trades by id.
 * Accepts no optional parameters
 */
OANDA.trade.listSpecific = function(accountId, tradeIds, callback) {
    var tradesStr = tradeIds.join(',');
    OANDA.api("/v1/accounts/" + accountId + "/trades", 'GET', {ids : tradesStr}, callback);
};

/* Close an existing trade
 * Accepts no optional parameters.
 */
OANDA.trade.close = function(accountId, tradeId, callback) {
    OANDA.api("/v1/accounts/" + accountId + "/trades/" + tradeId, 'DELETE', {}, callback);
};

/* Modfify and existing trade
 * Accepts optional parameters:
 *  stopLoss     => number
 *  takeProfit   => number
 *  trailingStop => number
 */
OANDA.trade.change = function(accountId, tradeId, optParameters, callback) {
    OANDA.api("/v1/accounts/" + accountId + "/trades/" + tradeId, 'PATCH', optParameters, callback);
};

OANDA.order = OANDA.order || {};


/* List all orders in account.
 * Accepts optional parameters:
 * maxId      => Number
 * count      => Number
 * Instrument => String
 */
OANDA.order.list = function(accountId, optParameters, callback) {
    if(optParameters.ids) { delete optParameters.ids; }
    OANDA.api("/v1/accounts/" + accountId + "/orders", 'GET', optParameters, callback);
};

/* List specific orders by id.
 * Accepts no optional parameters
 */
OANDA.order.listSpecific = function(accountId, orderIds, callback) {
    var ordersStr = orderIds.join(',');
    OANDA.api("/v1/accounts/" + accountId + "/orders", 'GET', {ids: ordersStr}, callback);
};

/* Create a new order.
 * expiry and price are only required if order type is 'marketIfTouched', 'stop' or 'limit'
 * Accepts optional parameters
 * expiry       => string RFC 3339 format
 * price        => number
 * stopLoss     => number
 * takeProfit   => number
 * trailingStop => number
 * upperBound   => number
 * lowerBound   => number
 */
OANDA.order.open = function(accountId, instrument, units, side, type, optParameters, callback) {
    OANDA.api("/v1/accounts/" + accountId + "/orders", 'POST',
              $.extend({instrument: instrument, units: units, side:side, type:type}, optParameters),
              callback);
};

/* Close an existing order.
 * Accepts no optional parameters
 */
OANDA.order.close = function(accountId, orderId, callback) {
    OANDA.api("/v1/accounts/" + accountId + "/orders/" + orderId, 'DELETE', {}, callback);
};

/* Modify an existing order
 * Accepts optional parameters:
 * units        => number
 * price        => number
 * expiry       => string
 * lowerBound   => number
 * upperBound   => number
 * stopLoss     => number
 * takeProfit   => number
 * trailingStop => number
 */
OANDA.order.change = function(accountId, orderId, optParameters, callback) {
    OANDA.api("/v1/accounts/" + accountId + "/orders/" + orderId, 'PATCH', optParameters, callback);
};

OANDA.position = OANDA.position || {};

/* List all positions
 * Accepts no optional parameters
 */
OANDA.position.list = function(accountId, callback) {
    OANDA.api("/v1/accounts/" + accountId + "/positions", 'GET', {}, callback);
};

/* List only position for specific instrument
 * Accepts no optional parameters
 */
OANDA.position.listSpecific = function(accountId, instrument, callback) {
    OANDA.api("/v1/accounts/" + accountId + "/positions/" + instrument, 'GET' ,{}, callback);
};

/* Close all trades in a positions
 * Accepts no optional parameters
 */
OANDA.position.close = function(accountId, instrument, callback) {
    OANDA.api("/v1/accounts/" + accountId + "/positions/" + instrument, 'DELETE', {}, callback);
};

OANDA.account = OANDA.account || {};

/* Register an account
 * Accepts no optional parameters
 */
OANDA.account.register = function(currency, callback) {
    OANDA.api("/v1/accounts", 'POST', {currency:currency}, callback);
};

/* Get accounts
 * Accepts no optional parameters
 */
OANDA.account.get = function(callback) {
    OANDA.api("/v1/accounts", 'GET', {}, callback);
};

/* List all accounts associated with user
 * Accepts no optional parameters
 */
OANDA.account.list = function(username, callback) {
    OANDA.api("/v1/accounts", 'GET', {username:username}, callback);
}

/* List specific account details
 * Accepts no optional parameters
 */
OANDA.account.listSpecific = function(accountId, callback) {
    OANDA.api("/v1/accounts/" + accountId, 'GET', {}, callback);
}

OANDA.rate = OANDA.rate || {};

/* List all instruments available.
 * Accepts optional parameters:
 * fields => array of strings
 */
OANDA.rate.instruments = function(accountId, fields, callback) {
    var fieldStr = fields.join(',');
    var data = fieldStr ? { "fields" : fieldStr , "accountId" : accountId} : {};
    OANDA.api("/v1/instruments", 'GET', data, callback);
};

/* Return candlesticks for a specific instrument
 * Accepts optional parameters:
 * granularity  => string
 * count        => number
 * start        => string
 * end          => string
 * candleFormat => string
 * includeFirst => boolean
 */
OANDA.rate.history = function(symbol, optParameters, callback) {
    OANDA.api("/v1/candles", 'GET', $.extend({instrument:symbol}, optParameters), callback);
};

/* Lists the current price for a list of instruments
 * Accepts no optional parameters
 */
OANDA.rate.quote = function(symbols, callback) {
    OANDA.api("/v1/prices", 'GET', {instruments: symbols.join(',')}, callback);
};


    var result = $("#result");

    OANDA.baseURL = "http://api-sandbox.oanda.com";
    OANDA.auth.enabled = false;
    //Create a fresh account
    function createAccount() {
	    result.append("<tr><td>createAccount</td><td id='createAcct'>fail</td><td id='acctid'>123</td></tr>");
        OANDA.account.register('USD', function(createAcctResponse) {
            var accountId = createAcctResponse.accountId;
            openMarketOrder(accountId);
	    $("#acctid").text(accountId);
	    $("#createAcct").text('pass');
        });
    }

    createAccount();
    function openMarketOrder(accountId) {
	    result.append("<tr><td>openMarketOrder</td><td id='openMarketOrder'>fail</td><td id='acctid'>123</td></tr>");
        OANDA.order.open(accountId, 'EUR_USD', 100, 'sell', 'market', {'trailingStop' : 100}, function(openMarketOrderResponse) {
            var units = openMarketOrderResponse.units;
            var side = openMarketOrderResponse.side;
            var instrument = openMarketOrderResponse.instrument;
            var time = openMarketOrderResponse.time;
            listTrade(accountId);
            $("#openMarketOrder").text('pass');
        });
    }

    function listTrade(accountId) {
        result.append("<tr><td>listTrade</td><td id='listTrade'>fail</td></tr>");
        OANDA.trade.list(accountId, {instrument : 'EUR_USD'}, function(response) {
            var ids = new Array();
            ids[0] = response.trades[0].id;
            listTradeSpecific(accountId, ids);
            $("#listTrade").text('pass');
        });
    }

    function listTradeSpecific(accountId, ids) {
        result.append("<tr><td>listTradeSpecific</td><td id='listTradeSpecific'>fail</td></tr>");
        OANDA.trade.listSpecific(accountId, ids, function(response) {
            var id = response.trades[0].id;
            changeTrade(accountId, id);
            $("#listTradeSpecific").text('pass');
        });
    }

    function changeTrade(accountId, id) {
        result.append("<tr><td>changeTrade</td><td id='changeTrade'>fail</td></tr>");
        OANDA.trade.change(accountId, id, {'stopLoss' : 99, 'takeProfit' : 0.1, 'trailingStop' : 51}, function(response) {
            var changeTradeTransId = response.id;
            deleteTrade(accountId, id);
            $("#changeTrade").text('pass');
        });
    }

    function deleteTrade(accountId, id) {
        result.append("<tr><td>deleteTrade</td><td id='deleteTrade'>fail</td></tr>");
        OANDA.trade.close(accountId, id, function(response) {
            var tradeId = response.id;
            $("#deleteTrade").text('pass');
            openOrder(accountId);
        });
    }

    function openOrder(accountId) {
        result.append("<tr><td>openOrder</td><td id='openOrder'>fail</td></tr>");
        var expDate = new Date();
        expDate.setTime(expDate.getTime() + 10*60*60*1000); //Add 10 hours.
        OANDA.order.open(accountId, 'EUR_USD', 100, 'buy', 'marketIfTouched', {'trailingStop' : 60, 'price' : '5.67' , 'expiry' : expDate.toISOString()}, function(openOrderResponse) {
            var units = openOrderResponse.units;
            var side = openOrderResponse.side;
            var instrument = openOrderResponse.instrument;
            var time = openOrderResponse.time;
            listOrder(accountId);
            $("#openOrder").text('pass');
        });
    }

    function listOrder(accountId) {
        result.append("<tr><td>listOrder</td><td id='listOrder'>fail</td></tr>");
        OANDA.order.list(accountId, {'instrument' : 'EUR_USD' }, function(response) {
            var ids = new Array();
            ids[0] = response.orders[0].id;
            listOrderSpecific(accountId, ids);
            $("#listOrder").text('pass');
        });
    }

    function listOrderSpecific(accountId, ids) {
        result.append("<tr><td>listOrderSpecific</td><td id='listOrderSpecific'>fail</td></tr>");
        OANDA.order.listSpecific(accountId, ids, function(response) {
            var id = response.orders[0].id;
            changeOrder(accountId, id);
            $("#listOrderSpecific").text('pass');
        });
    }

    function changeOrder(accountId, id) {
        result.append("<tr><td>changeOrder</td><td id='changeOrder'>fail</td></tr>");
        OANDA.order.change(accountId, id, {'trailingStop' : 100, 'units' : 60} ,function(response) {
            var changeOrderTransId = response.id;
            $("#changeOrder").text('pass');
            deleteOrder(accountId, id);
        });
    }

    function deleteOrder(accountId, id) {
        result.append("<tr><td>deleteOrder</td><td id='deleteOrder'>fail</td></tr>");
        OANDA.order.close(accountId, id, function(response) {
            var orderId = response.id;
            var ocaGroupId = response.id;
            $("#deleteOrder").text('pass');
            transactionList(accountId);
        });
    }

    function transactionList(accountId) {
        result.append("<tr><td>transactionList</td><td id='transactionList'>fail</td></tr>");
        OANDA.transaction.list(accountId, {'ids' : '2347', 'instrument' : 'EUR_USD'}, function(response) {
            var id = response.transactions[0].id;
            $("#transactionList").text('pass');
            transactionListSpecific(accountId, id);
        });
    }

    function transactionListSpecific(accountId, id) {
        result.append("<tr><td>transactionListSpecific</td><td id='transactionListSpecific'>fail</td></tr>");
        OANDA.transaction.listSpecific(accountId, id, function(response) {
            var id = response.id;
            $("#transactionListSpecific").text('pass');
            getInstruments();
        });
    }

    function getInstruments()  {
        result.append("<tr><td>getInstruments</td><td id='getInstruments'>fail</td></tr>");
        OANDA.rate.instruments(['pip'], [''], function(response) {
            var pip = response.instruments[0].pip;
            var inst = response.instruments[0].instrument;
            $("#getInstruments").text('pass');
            getRates();
        });
    }

    function getRates() {
        result.append("<tr><td>getRates</td><td id='getRates'>fail</td></tr>");
        OANDA.rate.quote(['EUR_USD'], function(response) {
            var bid = response.prices[0].bid;
            var ask = response.prices[0].ask;
            $("#getRates").text('pass');
            getHistory();
        });
    }

    function getHistory()
    {
        result.append("<tr><td>getHistory</td><td id='getHistory'>fail</td></tr>");
        OANDA.rate.history("EUR_USD", {'granularity' : "S5", 'count' : "2"}, function(response) {
            var openMid = response.candles[0].openBid;
            var highMid = response.candles[0].openAsk;
            var lowMid = response.candles[0].closeMid;
            var closeMid = response.candles[0].closeAsk;
            $("#getHistory").text('pass');
        });
    }

</script>
</html>
